<%= form_with(model: expense, local: true, class: "max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md") do |form| %>
  <% if expense.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
      <h3 class="text-red-800 font-medium mb-2"><%= pluralize(expense.errors.count, "error") %> prohibited this expense from being saved:</h3>
      <ul class="text-red-700 text-sm list-disc list-inside">
        <% expense.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :amount, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.number_field :amount, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div>
      <%= form.label :expense_date, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.date_field :expense_date, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div>
      <%= form.label :expense_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :expense_type, options_for_select([["Personal", "personal"], ["Business", "business"]], expense.expense_type), { prompt: "Select type" }, { class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" } %>
    </div>

    <div>
      <%= form.label :category, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :category, placeholder: "e.g., Food, Transport, Office", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div class="md:col-span-2">
      <%= form.label :vendor, "Vendor (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :vendor, placeholder: "Store or vendor name (optional)", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div class="md:col-span-2">
      <%= form.label :description, "Description (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_area :description, rows: 3, placeholder: "What was this expense for? (optional)", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div class="md:col-span-2">
      <%= form.label :notes, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_area :notes, rows: 2, placeholder: "Additional notes (optional)", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
    </div>

    <div class="md:col-span-2">
      <%= form.label :receipts, "Receipt/Invoice Files", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="mt-2">
        <%= form.file_field :receipts, multiple: true, accept: "image/*,application/pdf", class: "block w-full text-sm text-gray-500
          file:mr-4 file:py-2 file:px-4
          file:rounded-md file:border-0
          file:text-sm file:font-semibold
          file:bg-blue-50 file:text-blue-700
          hover:file:bg-blue-100" %>
        <p class="mt-1 text-xs text-gray-500">Upload receipt or invoice files (PDF, JPG, PNG)</p>
      </div>
    </div>

    <!-- Recurring Expense Section -->
    <div class="md:col-span-2 border-t pt-6 mt-6">
      <div class="flex items-center mb-4">
        <%= form.check_box :is_recurring, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded", data: { action: "change->expense#toggleRecurrence" } %>
        <%= form.label :is_recurring, "Make this a recurring expense", class: "ml-2 text-sm font-medium text-gray-700" %>
      </div>

      <div id="recurrence-fields" class="<%= 'hidden' unless expense.persisted? && expense.is_recurring %> space-y-4 pl-6 border-l-2 border-purple-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= form.label :recurrence_frequency, "Frequency", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.select :recurrence_frequency,
                options_for_select([["Daily", "daily"], ["Weekly", "weekly"], ["Monthly", "monthly"], ["Yearly", "yearly"]], expense.recurrence_frequency),
                { prompt: "Select frequency" },
                { class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" } %>
          </div>

          <div>
            <%= form.label :recurrence_start_date, "Start Date", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.date_field :recurrence_start_date, value: expense.recurrence_start_date || expense.expense_date, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" %>
          </div>

          <div class="md:col-span-2">
            <%= form.label :recurrence_end_date, "End Date (optional - leave blank for ongoing)", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.date_field :recurrence_end_date, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" %>
          </div>
        </div>

        <div class="bg-purple-50 border border-purple-200 rounded-md p-3">
          <p class="text-xs text-purple-700">
            <strong>Note:</strong> Future expenses will be auto-generated based on this schedule. You can attach receipts to each generated expense individually.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 flex justify-end">
    <%= form.submit class: "px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const recurringCheckbox = document.querySelector('[name="expense[is_recurring]"]');
    const recurrenceFields = document.getElementById('recurrence-fields');

    if (recurringCheckbox) {
      recurringCheckbox.addEventListener('change', function() {
        if (this.checked) {
          recurrenceFields.classList.remove('hidden');
        } else {
          recurrenceFields.classList.add('hidden');
        }
      });
    }
  });
</script>